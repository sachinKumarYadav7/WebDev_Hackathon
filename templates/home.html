<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Dashboard</title>
    <link rel="stylesheet" type="text/css" href="../static/css/dashboard.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #6a1b9a;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            color: whitesmoke;
        }
        .navbar-brand img {
            height: 40px;
        }
        .nav-link.active {
            background-color: #8e24aa;
        }
        .view-more {
            text-align: right;
            margin-top: 10px;
        }
        .navbar-text {
            padding: 12px;
        }
        #announcement {
            width: 100%;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }
        
        .notfound {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; 
            text-align: center;
            font-size: 1.5em;
            color: #666; 
            /* margin-left: 25%; */
        }
        #searchButton{
            height: 40px;
            /* margin: 10px; */
        }
        .card-container {
            position: relative;
            width: 300px;  
            height: 200px; 
            /* perspective: 1000px; */
        }
       

        .card {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease, opacity 0.5s ease;
            backface-visibility: hidden; 
            /* will-change: transform, opacity;  */
        }
      
        #loading {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        #show_rem:hover{
            cursor: pointer;
        }
        .advertisements {
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 230px;
        }

        .advertisement {
            position: absolute;
            width: 100%;
            height: 500px;
            top: 0;
            left: 100%;
            transition: transform 1s ease-in-out;
            opacity: 0;
        }

        .advertisement.active {
            transform: translateX(-100%);
            opacity: 1;
        }
        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        .dark-mode .navbar {
            background-color: #333333;
        }

        .dark-mode .navbar-nav .nav-link {
            color: #ffffff !important;
        }

        .dark-mode .nav-link.active {
            background-color: #444444;
        }
        a{
            color: #ffffff !important;
        }
        .dark-mode .card, .dark-mode #announcement {
            background-color: #444444;
            color: #ffffff;
            border-color: #444444;
        }

        .dark-mode .advertisement {
            background-color: #444444;
            color: #ffffff;
        }

        .dark-mode .modal-content {
            background-color: #333333;
            color: #ffffff;
        }

        .dark-mode li {
            background-color: #333333;
            color: #ffffff;
        }
        .dark-mode .grid-item {
            background-color: #333333;
            color: #ffffff;
        }
        .dark-mode .list-group-item {
            background-color: #333333;
            color: #ffffff;
        }
        .footer{
            text-align: center;
            justify-content: center;
            margin: 10px;
            color: #c0b9b9;
        }
        
    </style>
</head>
<body>


    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <a class="navbar-brand" href="#">
            <img src="../static/images/iitdh.png" alt="Institute Logo">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item " id="bell">
                    <a class="nav-link active" id="dash" href="#" >Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="#" id="search_bar" >Explore Books</a>
                </li>
                <li class="nav-item">

                    <a class="nav-link" href="#" id="review_book">Review Book</a>

                    <a class="nav-link" href="{{ url_for('review') }}" id="review_book">Review Book</a>

                </li>
            </ul>
            {% if session.logged_in %}
            <ul class="navbar-nav ml-auto">
                <li>
                    <a class="navbar-brand" href="#" id="mode">
                        <img src="../static/images/moon.png" alt="Mode Toggle" id="imgmode">
                    </a>
                </li>

                <li class="nav-item">
                    <span class="navbar-text">
                       
                    </span>
                </li>

                <form class="form-inline my-2 ml-2 my-lg-0">
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </form>
            </ul>
            {% endif %}
        </div>
    </nav>
    <div class="alert alert-success" style="display: none; margin-top: 0px;" role="alert" id="success">
        This is a success alertâ€”check it out!
    </div>

    <div id="loading" >
        <!-- Your SVG animation -->
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="200" height="200" style="shape-rendering: auto; display: block; background: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-width="2" stroke="#1c79c0" fill="none" r="0" cy="50" cx="50">
            <animate begin="0s" calcMode="spline" keySplines="0 0.2 0.8 1" keyTimes="0;1" values="0;40" dur="1s" repeatCount="indefinite" attributeName="r"></animate>
            <animate begin="0s" calcMode="spline" keySplines="0.2 0 0.8 1" keyTimes="0;1" values="1;0" dur="1s" repeatCount="indefinite" attributeName="opacity"></animate>
          </circle><circle stroke-width="2" stroke="#0dd3ff" fill="none" r="0" cy="50" cx="50">
            <animate begin="-0.5s" calcMode="spline" keySplines="0 0.2 0.8 1" keyTimes="0;1" values="0;40" dur="1s" repeatCount="indefinite" attributeName="r"></animate>
            <animate begin="-0.5s" calcMode="spline" keySplines="0.2 0 0.8 1" keyTimes="0;1" values="1;0" dur="1s" repeatCount="indefinite" attributeName="opacity"></animate>
          </circle><g></g></g><!-- [ldio] generated by https://loading.io --></svg>
    </div>
    
    <div id="content">
        <div class="container" id="main-container">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h4 class="h4">Welcome, {{ session.user.name }}</h4>
            </div>  
            
            <div class="grid-container">
                <div class="grid-item card-stack-demo" id="grid">
                    <div class="card-stack" id="rem">
                            <!-- List of announcements will be dynamically inserted here -->
                    </div>
                </div>
                <div class="grid-item advertisement-board" id="ad">
                    <div class="advertisements">
                        <div id="branch-recommendations", class="advertisement"></div>
                        <div id="content-recommended"  class="advertisement">See what other guys are studying of your same interest</div>
                        <div id="recommended-books" class="advertisement"></div>
                        <!-- <div class="advertisement">You were looking for a Book in AI/ML, here are some</div>
                        <div class="advertisement">Other guys from your branch took this book, have a look</div>
                        <div class="advertisement">See what other guys are studying of your same interest</div> -->
                    </div>
                </div>
                <div class="grid-item" >
                    <h5>Pending Issue Requests</h5>
                    <ul id="issuelist" class="list-group mt-4">
                        <!-- List of announcements will be dynamically inserted here -->
                    </ul>
                </div>
                
            </div>

            <div class="announcement" id="announcement">
                <h5>Announcements</h5>
                <ul id="announcementList" class="list-group mt-4">
                    <!-- List of announcements will be dynamically inserted here -->
                </ul>
            </div>
            
        </div>

        <div id="new-container" style="display:none;">
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search for Books" id="searchbar">
            </div>
            <div class="form-row">
                <!-- <div class="sort"> -->
                    <div class="form-group col-md-3">
                        <select id="Genre" class="form-control">
                        <option selected>Genre</option>
                        
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <select id="dept" class="form-control">
                        <option >Department</option>
                        </select>
                    </div>
                <!-- </div> -->
                <div>
                    <button id="searchButton" class="btn btn-primary">Search</button>
                </div>

                
            </div>
            <div class="recent_searches">
                <!-- <h3>Recent Searches</h3> -->
                
            </div>

            
            <div class="row" id="books-container">
                <!-- Cards will be inserted here -->
            </div>
        </div>

        <div id="review" style="display:none;">
            <div class="container book-list">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h4 class="h4">Your Borrowed Books</h4>
                </div>  
                <div id="booksContainer" class="list-group">
                    <!-- Book items will be populated here by JavaScript -->
                </div>
            </div>

        </div>
        <div class="modal fade review-modal" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reviewModalLabel">Write a Review</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="reviewForm">
                            <div class="form-group">
                                <label for="reviewText">Review</label>
                                <textarea class="form-control" id="reviewText" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Rating</label><br>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reviewRating" id="rating1" value="1">
                                    <label class="form-check-label" for="rating1">1 - Poor</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reviewRating" id="rating2" value="2">
                                    <label class="form-check-label" for="rating2">2 - Fair</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reviewRating" id="rating3" value="3">
                                    <label class="form-check-label" for="rating3">3 - Good</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reviewRating" id="rating4" value="4">
                                    <label class="form-check-label" for="rating4">4 - Very Good</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="reviewRating" id="rating5" value="5">
                                    <label class="form-check-label" for="rating5">5 - Excellent</label>
                                </div>
                            </div>
                            <input type="hidden" id="bookId">
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </form>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="modal fade" id="issueModal" tabindex="-1" role="dialog" aria-labelledby="issueModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="issueModalLabel">Issue Book</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="modalContent"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <p id="bookname"></p>
                        <button type="submit" class="btn btn-primary" id="cissue" data-genre="Some Genre">Confirm Issue</button>
                    </div>
                </div>
            </div>
        </div>

        
        

        <div class="modal fade" id="show_rem" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">All your Issued Books</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div id="rem_body" class="modal-body">

                </div>
                
              </div>
            </div>
        </div>

        <div class="footer">
            Copyright &copy; 2024 &mdash; Boring-Asylum
        </div>

    </div>

    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const advertisements = document.querySelectorAll('.advertisement');
            let currentAdIndex = 0;

            function showNextAd() {
                advertisements[currentAdIndex].classList.remove('active');
                currentAdIndex = (currentAdIndex + 1) % advertisements.length;
                advertisements[currentAdIndex].classList.add('active');
            }

            // Initial display
            advertisements[currentAdIndex].classList.add('active');

            // Change advertisement every 5 seconds
            setInterval(showNextAd, 5000);
        });

        let genre_for_issreq;
        function load_all_books(){
            fetch('https://iit-dh-library.onrender.com/books')
            .then(response => response.json())
            .then(data => {
                const booksContainer = $('#books-container');
                if (data.length === 0) {
                    booksContainer.append('<p>No books available.</p>');
                } else {
                    // let genre_of_requested_book;
                    // console.log(data.length);
                    data.forEach(function(book) {
                        const truncatedTitle = book.title ? (book.title.length > 50 ? book.title.substring(0, 50) + '...' : book.title) : 'No title available';
                        const truncatedDesc = book.description ? (book.description.length > 100 ? book.description.substring(0, 100) + '...' : book.description) : 'No description available';
                    
                        let card;
                        

                        if(parseInt(book.count, 10) === 0){
                            // console.log(book);
                            card = `
                                <div class="col-md-4" >
                                    <div class="carda">
                                        <div class="card-body">
                                            <h5 class="card-title">${truncatedTitle}</h5>
                                            <p class="card-text">Author: ${book.author}</p>
                                            <p class="card-text">Description: ${truncatedDesc}</p>
                                            <p class="card-text">Count: ${book.count}</p>
                                            <p class="card-text text-warning">This book will be back soon.</p>

                                        </div>
                                    </div>
                                </div>
                            `;
                            
                        }
                        else{
                            // genre_of_requested_book = book.genre;
                            card = `
                            <div class="col-md-4">
                                <div class="carda">
                                    <div class="card-body">
                                        <h5 class="card-title">${truncatedTitle}</h5>
                                        <p class="card-text">Author: ${book.author}</p>
                                        <p class="card-text">Description: ${truncatedDesc}</p>
                                        <p class="card-text">Count: ${book.count}</p>
                                        <a href="#" class="btn btn-primary issue-btn" data-title="${book.title}" data-genre="${book.genre}">Issue</a>
                                    </div>
                                </div>
                            </div>
                        `;
                        }
                        booksContainer.append(card);
                    });

                    $('.issue-btn').click(function() {
                        const bookTitle = $(this).data('title');
                        genre_for_issreq = $(this).data('genre');

                        // console.log(`gen = ${genre_for_issreq}`);
                        $('#modalContent').text(`Do you want to issue the book: ${bookTitle}?`);
                        $('#issueModal').modal('show');
                        $('#bookname').data('title', bookTitle); 
                        // console.log(`${bookTitle}`);
                    });

                    $('#cissue').click(function() {
                        const bookTitle2 = $(this).data('title');
                        const genre = $(this).data('genre');
                        // console.log(`${bookTitle2}`);
                        // console.log(`gen = ${genre}`);
                    });
                }
            })
        }

        document.addEventListener('DOMContentLoaded', function () {
            load_all_books();
        });

       
        function loadAnnouncements() {
            var loading = document.getElementById("loading");
            fetch('https://iit-dh-library.onrender.com/announcements')
                .then(response => response.json())
                .then(data => {
                    if(data.length == 0){
                        announcementList.textContent = "No announcements available.";
                    }
                    else{

                        const announcementList = document.getElementById('announcementList');
                        announcementList.innerHTML = '';
                        data.forEach(announcement => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            
                            const utcDate = new Date(announcement.timestamp);
                            const istDate = new Date(utcDate.getTime() + (330 * 60000)); 
                            const formattedDate = istDate.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    
                            li.textContent = `${announcement.announcement} (Posted on: ${formattedDate})`;
                            announcementList.appendChild(li);
                        });
                    }
                    loading.style.display = "none";
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadAnnouncements();
        });
    
        document.getElementById('cissue').addEventListener('click' , function (e) {
            e.preventDefault();
                const issueText = document.getElementById('modalContent').textContent;
                const startIndex = issueText.indexOf(':') + 2;
                const endIndex = issueText.indexOf('?');
                const bookTitle = issueText.slice(startIndex, endIndex);
                // console.log(bookTitle.trim()); 
                var loading = document.getElementById("loading");

                loading.style.display = "block";
                loading.style.position = "fixed";
                loading.style.width = "100%";
                loading.style.height = "100%";
                loading.style.top = "0";
                loading.style.left = "0";
                loading.style.display = "flex";
                loading.style.justifyContent = "center";
                loading.style.alignItems = "center";
                loading.style.zIndex = "9999";
                loading.style.backdropFilter = "blur(5px)";

            fetch('https://iit-dh-library.onrender.com/issue_req' , {
                method: 'POST',
                headers:{
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ bookname: bookTitle.trim() , genre: genre_for_issreq}),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);

                $('#issueModal').modal('hide');
                loading.style.display = "none"; 
                const alert = document.getElementById('success');
                alert.textContent = `Success! Request for book "${bookTitle}" sent to administrator.`;
                alert.style.display = 'block';
                loadissuereqs();
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 6000); 

            })
            .catch((error) => {
                console.error('Error:', error);
            });
        });

        function loadissuereqs() {
            fetch('https://iit-dh-library.onrender.com/loadissuereqs', {
                    method: 'GET',
                    mode: 'cors'
                })
                .then(response => response.json())
                .then(data => {
                    if(data.length == 0){
                        issuelist.textContent = "No issue requests.";
                    }
                    else{

                        const announcementList = document.getElementById('issuelist');
                        announcementList.innerHTML = '';
                        data.forEach(req => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            
                            const utcDate = new Date(req.timestamp);
                            const istDate = new Date(utcDate.getTime() + (330 * 60000)); 
                            const formattedDate = istDate.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    
                            li.textContent = `${req.bookname} (${formattedDate})`;
                            announcementList.appendChild(li);
                        

                        });     
                    }
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadissuereqs();
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            const searchbar = document.getElementById('searchbar');

            searchbar.addEventListener('input', () => {
                const query = searchbar.value;
                var loading = document.getElementById("loading");

                loading.style.display = "block";
                loading.style.position = "fixed";
                loading.style.width = "100%";
                loading.style.height = "100%";
                loading.style.top = "0";
                loading.style.left = "0";
                loading.style.display = "flex";
                loading.style.justifyContent = "center";
                loading.style.alignItems = "center";
                loading.style.zIndex = "9999";
                loading.style.backdropFilter = "blur(5px)";

                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                })
                .then(response => response.json())
                .then(data => {
                    const booksContainer = document.getElementById('books-container');
                    booksContainer.innerHTML = '';
                    if(data.length === 0){
                        loading.style.display = "none"; 
                        const notfound = `<div class="notfound">
                                                <p>No matches for search : ${query}</p>
                                            </div>`;
                        booksContainer.insertAdjacentHTML('beforeend', notfound);
                    }
                    else{
                        data.forEach(function(book)  {
                            
                            const truncatedTitle = book.title ? (book.title.length > 50 ? book.title.substring(0, 50) + '...' : book.title) : 'No title available';
                            const truncatedDesc = book.description ? (book.description.length > 100 ? book.description.substring(0, 100) + '...' : book.description) : 'No description available';
                            let card;
                            loading.style.display = "none"; 

                            if(parseInt(book.count, 10) === 0){
                                card = `
                                <div class="col-md-4">
                                    <div class="carda">
                                        <div class="card-body">
                                            <h5 class="card-title">${truncatedTitle}</h5>
                                            <p class="card-text">Author: ${book.author}</p>
                                            <p class="card-text">Description: ${truncatedDesc}</p>
                                            <p class="card-text">Count: ${book.count}</p>
                                            <p class="card-text text-warning">This book will be back soon.</p>

                                        </div>
                                    </div>
                                </div>
                            `;
                            }
                            else{
                                card = `
                                <div class="col-md-4">
                                    <div class="carda">
                                        <div class="card-body">
                                            <h5 class="card-title">${truncatedTitle}</h5>
                                            <p class="card-text">Author: ${book.author}</p>
                                            <p class="card-text">Description: ${truncatedDesc}</p>
                                            <p class="card-text">Count: ${book.count}</p>
                                            <a href="#" class="btn btn-primary issue-btn" data-title="${book.title}" data-genre="${book.genre}">Issue</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                            }
                            booksContainer.insertAdjacentHTML('beforeend', card);
                            
                        });
                    }
                    $('.issue-btn').click(function() {
                        const bookTitle = $(this).data('title');
                        genre_for_issreq = $(this).data('genre');

                        $('#modalContent').text(`Do you want to issue the book: ${bookTitle}?`);
                        $('#issueModal').modal('show');
                        $('#bookname').data('title', bookTitle); 
                    });

                    $('#cissue').click(function() {
                        const bookTitle2 = $(this).data('title');
                        // console.log(`${bookTitle2}`);
                    });
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            var searchButton = document.getElementById("searchButton");
            searchButton.addEventListener("click", function() {
                var e_genre = document.getElementById("Genre");
                var genre = e_genre.value;
                var e_dept = document.getElementById("dept");
                var dept = e_dept.value;
                var loading = document.getElementById("loading");

                loading.style.display = "block";
                loading.style.position = "fixed";
                loading.style.width = "100%";
                loading.style.height = "100%";
                loading.style.top = "0";
                loading.style.left = "0";
                loading.style.display = "flex";
                loading.style.justifyContent = "center";
                loading.style.alignItems = "center";
                loading.style.zIndex = "9999";
                loading.style.backdropFilter = "blur(5px)";

                // console.log("Genre: " + genre);
                // console.log("Department: " + dept);

                var query = {
                    genre: genre,
                    dept: dept
                };

                fetch('/search_by_genre_and_dept', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(query),
                })
                .then(response => response.json())
                .then(data => {
                    const booksContainer = document.getElementById('books-container');
                    booksContainer.innerHTML = '';
                    if (data.length === 0) {
                        loading.style.display = "none"; 
                        const notfound = `<div class="notfound">
                            <p>No matches for search : ${JSON.stringify(query)}</p>
                        </div>`;
                        booksContainer.insertAdjacentHTML('beforeend', notfound);
                    } else {
                        data.forEach(function(book) {
                            const truncatedTitle = book.title ? (book.title.length > 50 ? book.title.substring(0, 50) + '...' : book.title) : 'No title available';
                            const truncatedDesc = book.description ? (book.description.length > 100 ? book.description.substring(0, 100) + '...' : book.description) : 'No description available';
                            let card;
                            loading.style.display = "none"; 

                            if(parseInt(book.count, 10) === 0){
                                card = `
                                <div class="col-md-4">
                                    <div class="carda">
                                        <div class="card-body">
                                            <h5 class="card-title">${truncatedTitle}</h5>
                                            <p class="card-text">Author: ${book.author}</p>
                                            <p class="card-text">Description: ${truncatedDesc}</p>
                                            <p class="card-text">Count: ${book.count}</p>
                                            <p class="card-text text-warning">This book will be back soon.</p>

                                        </div>
                                    </div>
                                </div>
                            `;
                            }
                            else{
                                card = `
                                <div class="col-md-4">
                                    <div class="carda">
                                        <div class="card-body">
                                            <h5 class="card-title">${truncatedTitle}</h5>
                                            <p class="card-text">Author: ${book.author}</p>
                                            <p class="card-text">Description: ${truncatedDesc}</p>
                                            <p class="card-text">Count: ${book.count}</p>
                                            <a href="#" class="btn btn-primary issue-btn" data-title="${book.title}" data-genre="${book.genre}">Issue</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                            }
                            booksContainer.insertAdjacentHTML('beforeend', card);
                        });
                    }

                    document.querySelectorAll('.issue-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const bookTitle = this.getAttribute('data-title');
                            genre_for_issreq = $(this).data('genre');

                            document.getElementById('modalContent').textContent = `Do you want to issue the book: ${bookTitle}?`;
                            document.getElementById('issueModal').dataset.title = bookTitle;
                            $('#issueModal').modal('show');
                        });
                    });

                    document.getElementById('cissue').addEventListener('click', function() {
                        const bookTitle2 = this.getAttribute('data-title');
                        // console.log(`${bookTitle2}`);
                    });
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            });
        }); 

        

        document.addEventListener('DOMContentLoaded', function () {
            let num_of_accbooks = 0;

            function load_acc_by_user() {
                fetch('https://iit-dh-library.onrender.com/load_acc_by_user', {
                        method: 'GET',
                        mode: 'cors'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const rem = document.getElementById('rem');
                        rem.innerHTML = '';
                        const remBody = document.getElementById('rem_body');
                        remBody.innerHTML = '';

                        if (data.length === 0) {
                            const notfound = `<div class="notfound">
                                                <p>You don't have any issued books!</p>
                                            </div>`;
                            rem.insertAdjacentHTML('beforeend', notfound);
                        } else {
                            num_of_accbooks = data.length;
                            data.forEach(function(book) {
                                const truncatedTitle = book.req.bookname ? 
                                    (book.req.bookname.length > 40 ? book.req.bookname.substring(0, 40) + '...' : book.req.bookname) : 
                                    'No title available';
                                
                                    const bookTimestamp = new Date(book.req.timestamp);
                                    const now = new Date();

                                    const bookDueDate = new Date(bookTimestamp.getTime() + 7 * 24 * 60 * 60 * 1000);

                                    const timeDiff = Math.abs(bookDueDate - now);

                                    const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                    const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                                    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                                    const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                                    const formattedDueDate = bookDueDate.toLocaleDateString('en-US', options);

                                    const card = `
                                        <div class="card">
                                            <div class="card-content">
                                                <h2>Reminder</h2> 
                                                <strong>Book</strong>: ${truncatedTitle} <br> 
                                                <strong>Deadline</strong>: ${formattedDueDate} <br>
                                                <strong>Time remaining</strong>: ${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds
                                            </div>
                                        </div>
                                    `;
                                    rem.insertAdjacentHTML('beforeend', card);

                            
                                
                                });

                                fetch('https://iit-dh-library.onrender.com/load_acc_by_user')
                                .then(response => response.json())
                                .then(data => {
                                    const rembody = document.getElementById('rem_body');
                                    rembody.innerHTML = '';

                                    if(data.length == 0){
                                        rembody.textContent = "No books issued.";
                                    }
                                    else{
                                        data.forEach(book => {
                                            const truncatedTitle = book.req.bookname ? 
                                            (book.req.bookname.length > 40 ? book.req.bookname.substring(0, 40) + '...' : book.req.bookname) : 
                                            'No title available';

                                            const bookTimestamp = new Date(book.req.timestamp);
                                            const now = new Date();

                                            const bookDueDate = new Date(bookTimestamp.getTime() + 7 * 24 * 60 * 60 * 1000);

                                            const timeDiff = Math.abs(bookDueDate - now);

                                            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                                            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                                            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);

                                            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                                            const formattedDueDate = bookDueDate.toLocaleDateString('en-US', options);
                                            const li = document.createElement('li');
                                            li.className = 'list-group-item';
                    
                                            li.innerHTML = `
                                                <strong>Book</strong>: ${truncatedTitle} <br>
                                                <strong>Deadline</strong>: ${formattedDueDate} <br>
                                                <strong>Time remaining</strong>: ${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds
                                            `;
                                            rembody.appendChild(li);
                                        });
                                    }
                                });
                                
                                document.getElementById('rem').addEventListener('click', function() {
                                    $('#show_rem').modal('show');
                                });




                            const cards = document.querySelectorAll('.card');
                            let currentIndex = 0;

                            function showNextCard() {
                                cards.forEach((card, index) => {
                                    if (index === currentIndex) {
                                        card.style.transform = `translateZ(${index * -20}px)`;
                                        card.style.opacity = 1;
                                    } else {
                                        card.style.transform = `translateZ(${(index - currentIndex) * -20}px)`;
                                        card.style.opacity = 0;
                                    }
                                });

                                currentIndex = (currentIndex + 1) % num_of_accbooks;
                                
                            }

                            setInterval(showNextCard, 3000);
                            showNextCard();
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }

            
            load_acc_by_user();
        });

        const genres = [
            'Algorithms', 'Artificial Intelligence', 'Software Engineering',
            'Computational Theory', 'Programming', 'Networking', 'Database Systems',
            'Operating Systems', 'Compilers', 'Machine Learning',
            'Computer Architecture', 'Dynamics', 'Thermodynamics', 'Design',
            'Materials Science', 'Fluid Mechanics', 'Vibrations',
            'Finite Element Analysis', 'Heat Transfer', 'Statics', 'Mechanisms',
            'Mathematics', 'Robotics', 'Experimentation',
            'General Electrical Engineering', 'Circuits', 'Power Systems',
            'Microelectronics', 'Digital Design', 'Signals and Systems',
            'Control Systems', 'Electric Machinery', 'Electromagnetics',
            'Communication Systems', 'Power Electronics', 'Digital Signal Processing',
            'Analog Design', 'Wireless Communication', 'Foundation Engineering',
            'Structural Engineering', 'Materials Engineering', 'Water Resources',
            'Transportation Engineering', 'Geotechnical Engineering',
            'Construction Management', 'Environmental Engineering',
            'Hydraulic Engineering', 'General Chemical Engineering',
            'Transport Processes', 'Reaction Engineering', 'Process Control', 'Safety',
            'Reference', 'Biochemical Engineering', 'Bioseparations',
            'Separation Processes', 'Mass Transfer', 'Catalysis', 'Process Engineering',
            'Quantum Mechanics', 'Classical Mechanics', 'Modern Physics', 'Optics',
            'Solid State Physics', 'Statistical Physics', 'Photonics', 'Nuclear Physics',
            'Plasma Physics', 'Thermal Physics', 'Applied Physics', 'Electronics',
            'Electrodynamics', 'Quantum Physics', 'General Physics',
            'Computational Physics'
        ];

        const genreSelect = document.getElementById('Genre');

        genres.forEach(genre => {
            const option = document.createElement('option');
            option.value = genre;
            option.textContent = genre;
            genreSelect.appendChild(option);
        });


        const dept = ['Computer Science', 'Mechanical Engineering',
       'Electrical Engineering', 'Civil Engineering',
       'Chemical Engineering', 'Engineering Physics'];

        const deptselect = document.getElementById('dept');

        dept.forEach(dep => {
            const option = document.createElement('option');
            option.value = dep;
            option.textContent = dep;
            deptselect.appendChild(option);
        });

        document.addEventListener('DOMContentLoaded', function () {

            const advertisements = document.querySelectorAll('.advertisement');
            let currentAdIndex = 0;

            function showNextAd() {
                advertisements[currentAdIndex].classList.remove('active');
                currentAdIndex = (currentAdIndex + 1) % advertisements.length;
                advertisements[currentAdIndex].classList.add('active');
            }

            advertisements[currentAdIndex].classList.add('active');
            setInterval(showNextAd, 5000);

            // Fetching recommendations
            const userId = 220010052; // Replace with dynamic user_id as needed
            const title = "Introduction to Algorithms"; // Replace with dynamic title as needed

            // Fetch hybrid recommendations
            fetch(`/recommend?title=${title}&user_id=${userId}&num_recommendations=3`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    let booksDiv = document.getElementById('recommended-books');
                    booksDiv.innerHTML = '<p>Here are some books based on what other student of same interest are studing :</p>'; // Add personalized message
                    data.forEach(book => {
                        let bookDiv = document.createElement('div');
                        bookDiv.classList.add('book');
                        bookDiv.innerHTML = `<strong>${book.title}</strong><br>by ${book.author}`;
                        booksDiv.appendChild(bookDiv);
                    });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    let booksDiv = document.getElementById('recommended-books');
                    booksDiv.innerHTML = 'Failed to load recommendations.';

    const advertisements = document.querySelectorAll('.advertisement');
    let currentAdIndex = 0;

    function showNextAd() {
        advertisements[currentAdIndex].classList.remove('active');
        currentAdIndex = (currentAdIndex + 1) % advertisements.length;
        advertisements[currentAdIndex].classList.add('active');
    }

    advertisements[currentAdIndex].classList.add('active');
    setInterval(showNextAd, 5000);

    // Fetching recommendations
    const userId = 220010052; // Replace with dynamic user_id as needed
    const title = "Introduction to Algorithms"; // Replace with dynamic title as needed

    // Fetch hybrid recommendations
    fetch(`/recommend?title=${title}&user_id=${userId}&num_recommendations=3`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            let booksDiv = document.getElementById('recommended-books');
            booksDiv.innerHTML = '<p>Here are some books based on what other student of same interest are studing :</p>'; // Add personalized message
            data.forEach(book => {
                let bookDiv = document.createElement('div');
                bookDiv.classList.add('book');
                bookDiv.innerHTML = `<strong>${book.title}</strong><br>by ${book.author}`;
                booksDiv.appendChild(bookDiv);
            });
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
            let booksDiv = document.getElementById('recommended-books');
            booksDiv.innerHTML = 'Failed to load recommendations.';
        });

    // Fetch content-based recommendations
    fetch(`/recommend1?title=${title}&num_recommendations=3`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            let booksDiv = document.getElementById('content-recommended');
            booksDiv.innerHTML = '<p>Here are some books based on your search history :</p>'; // Add personalized message
            data.forEach(book => {
                let bookDiv = document.createElement('div');
                bookDiv.classList.add('book');
                bookDiv.innerHTML = `<strong>${book.title}</strong><br>by ${book.author}`;
                booksDiv.appendChild(bookDiv);
            });
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
            let booksDiv = document.getElementById('content-recommended');
            booksDiv.innerHTML = 'Failed to load recommendations.';
        });

    // Branch Wise Recommendations
    fetch('/recommend2')
        .then(response => response.json())
        .then(data => {
            let recommendationsDiv = document.getElementById('branch-recommendations');
            if (data.error) {
                recommendationsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
            } else {
                recommendationsDiv.innerHTML = '<p>Just look what students from your branch are studying:</p>'; // Add personalized message
                let recommendationsList = '<ul>';
                data.forEach(book => {
                    recommendationsList += `<li>${book}</li>`;

                });
                recommendationsList += '</ul>';
                recommendationsDiv.innerHTML += recommendationsList;
            }
        })
        .catch(error => {
            document.getElementById('branch-recommendations').innerHTML = `<p>Error: ${error.message}</p>`;
        });
});

            // Fetch content-based recommendations
            fetch(`/recommend1?title=${title}&num_recommendations=3`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    let booksDiv = document.getElementById('content-recommended');
                    booksDiv.innerHTML = '<p>Here are some books based on your search history :</p>'; // Add personalized message
                    data.forEach(book => {
                        let bookDiv = document.createElement('div');
                        bookDiv.classList.add('book');
                        bookDiv.innerHTML = `<strong>${book.title}</strong><br>by ${book.author}`;
                        booksDiv.appendChild(bookDiv);
                    });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    let booksDiv = document.getElementById('content-recommended');
                    booksDiv.innerHTML = 'Failed to load recommendations.';
                });

            // Branch Wise Recommendations
            fetch('/recommend2')
                .then(response => response.json())
                .then(data => {
                    let recommendationsDiv = document.getElementById('branch-recommendations');
                    if (data.error) {
                        recommendationsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                    } else {
                        recommendationsDiv.innerHTML = '<p>Just look what students from your branch are studying:</p>'; // Add personalized message
                        let recommendationsList = '<ul>';
                        data.forEach(book => {
                            recommendationsList += `<li>${book}</li>`;
                        });
                        recommendationsList += '</ul>';
                        recommendationsDiv.innerHTML += recommendationsList;
                    }
                })
                .catch(error => {
                    document.getElementById('branch-recommendations').innerHTML = `<p>Error: ${error.message}</p>`;
                });
        });

            $.get("/load_acc_by_user", function(data) {
                var books = JSON.parse(data);
                var booksContainer = $("#booksContainer");

                if (books.length === 0) {
                    booksContainer.append('<p class="list-group-item">No books borrowed.</p>');
                } else {
                    books.forEach(function(book) {
                        var bookItem = `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h5><strong>Book: </strong>${book.req.bookname}</h5>
                                    <span>${book.req.genre}</span>
                                </div>
                                <button class="btn btn-primary review-btn" data-book-id="${book._id}" data-book-title="${book.req.bookname}">Review</button>
                            </div>
                        `;
                        booksContainer.append(bookItem);
                    });
                }
            });

            $(document).on("click", ".review-btn", function() {
                var bookId = $(this).data("book-id");
                var bookTitle = $(this).data("book-title");
                $("#reviewModalLabel").text("Write a Review for " + bookTitle);
                $("#bookId").val(bookId);
                $("#reviewModal").modal("show");
            });

            $("#reviewForm").submit(function(event) {
                event.preventDefault();
                var bookId = $("#bookId").val();
                var reviewText = $("#reviewText").val();
                var reviewRating = $("input[name='reviewRating']:checked").val();

                $.post("/submit_review", {
                    book_id: bookId,
                    review: reviewText,
                    rating: reviewRating
                }, function(response) {
                    alert(response.message);
                    $("#reviewModal").modal("hide");
                }).fail(function(response) {
                    alert("Failed to submit review: " + response.responseJSON.message);
                });
            });

    </script>
    
    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="../static/js/script_dashboard.js"></script>
    
</body>
</html>